From 4690d01e8dc44c1a87b6020bf39676c8a69c8f54 Mon Sep 17 00:00:00 2001
From: kmeaw <kmeaw@kmeaw.com>
Date: Sat, 27 Jun 2020 20:44:30 +0000
Subject: [PATCH 1/2] Add RB960GSP support

---
 .../ar71xx/base-files/etc/board.d/01_leds     |  1 +
 .../ar71xx/base-files/etc/board.d/02_network  |  1 +
 target/linux/ar71xx/base-files/etc/diag.sh    |  1 +
 target/linux/ar71xx/base-files/lib/ar71xx.sh  |  3 +++
 .../ar71xx/base-files/lib/upgrade/platform.sh |  2 ++
 .../files/arch/mips/ath79/Kconfig.openwrt     |  1 +
 .../ar71xx/files/arch/mips/ath79/mach-rbspi.c | 20 ++++++++++++++++++-
 .../ar71xx/files/arch/mips/ath79/machtypes.h  |  1 +
 target/linux/ar71xx/image/mikrotik.mk         |  2 +-
 ...MIPS-ath79-add-routerboard-detection.patch |  3 ++-
 10 files changed, 32 insertions(+), 3 deletions(-)

diff --git a/target/linux/ar71xx/base-files/etc/board.d/01_leds b/target/linux/ar71xx/base-files/etc/board.d/01_leds
index bd589c1..2a1e961 100755
--- a/target/linux/ar71xx/base-files/etc/board.d/01_leds
+++ b/target/linux/ar71xx/base-files/etc/board.d/01_leds
@@ -666,6 +666,7 @@ rb-952ui-5ac2nd)
 	ucidef_set_led_switch "port5" "port5" "rb:green:port5" "switch0" "0x02"
 	ucidef_set_led_wlan "wlan" "WLAN" "rb:blue:wlan" "phy0tpt"
 	;;
+rb-960pgs|\
 rb-962uigs-5hact2hnt)
 	ucidef_set_led_timer "user" "USER/SFP" "rb:green:user" "1000" "1000"
 	;;
diff --git a/target/linux/ar71xx/base-files/etc/board.d/02_network b/target/linux/ar71xx/base-files/etc/board.d/02_network
index 44fce97..faf8270 100755
--- a/target/linux/ar71xx/base-files/etc/board.d/02_network
+++ b/target/linux/ar71xx/base-files/etc/board.d/02_network
@@ -201,6 +201,7 @@ ar71xx_setup_interfaces()
 	rb-750gl|\
 	rb-751g|\
 	rb-951g-2hnd|\
+	rb-960pgs|\
 	rb-962uigs-5hact2hnt|\
 	wlr8100|\
 	wzr-hp-g450h)
diff --git a/target/linux/ar71xx/base-files/etc/diag.sh b/target/linux/ar71xx/base-files/etc/diag.sh
index 29bf2ad..6e0b781 100644
--- a/target/linux/ar71xx/base-files/etc/diag.sh
+++ b/target/linux/ar71xx/base-files/etc/diag.sh
@@ -377,6 +377,7 @@ get_status_led() {
 	rb-941-2nd|\
 	rb-951ui-2nd|\
 	rb-952ui-5ac2nd|\
+	rb-960pgs|\
 	rb-962uigs-5hact2hnt|\
 	rb-lhg-5nd|\
 	rb-map-2nd|\
diff --git a/target/linux/ar71xx/base-files/lib/ar71xx.sh b/target/linux/ar71xx/base-files/lib/ar71xx.sh
index 044ef4e..5f5a559 100755
--- a/target/linux/ar71xx/base-files/lib/ar71xx.sh
+++ b/target/linux/ar71xx/base-files/lib/ar71xx.sh
@@ -519,6 +519,9 @@ mikrotik_board_detect() {
 	*"952Ui-5ac2nD")
 		name="rb-952ui-5ac2nd"
 		;;
+	*"960PGS")
+		name="rb-960pgs"
+		;;
 	*"962UiGS-5HacT2HnT")
 		name="rb-962uigs-5hact2hnt"
 		;;
diff --git a/target/linux/ar71xx/base-files/lib/upgrade/platform.sh b/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
index e33b74a..f5d9a5f 100755
--- a/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
+++ b/target/linux/ar71xx/base-files/lib/upgrade/platform.sh
@@ -721,6 +721,7 @@ platform_check_image() {
 	rb-941-2nd|\
 	rb-951ui-2nd|\
 	rb-952ui-5ac2nd|\
+	rb-960pgs|\
 	rb-962uigs-5hact2hnt|\
 	rb-lhg-5nd|\
 	rb-map-2nd|\
@@ -750,6 +751,7 @@ platform_pre_upgrade() {
 	rb-941-2nd|\
 	rb-951ui-2nd|\
 	rb-952ui-5ac2nd|\
+	rb-960pgs|\
 	rb-962uigs-5hact2hnt|\
 	rb-lhg-5nd|\
 	rb-map-2nd|\
diff --git a/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt b/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt
index 6fd78c4..3cba567 100644
--- a/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt
+++ b/target/linux/ar71xx/files/arch/mips/ath79/Kconfig.openwrt
@@ -1183,6 +1183,7 @@ config ATH79_MACH_RBSPI
 	  MikroTik RouterBOARD hAP
 	  MikroTik RouterBOARD hAP ac
 	  MikroTik RouterBOARD hAP ac lite
+	  MikroTik RouterBOARD hEX PoE
 	  MikroTik RouterBOARD hEX PoE lite
 	  MikroTik RouterBOARD hEX lite
 	  MikroTik RouterBOARD Powerbox
diff --git a/target/linux/ar71xx/files/arch/mips/ath79/mach-rbspi.c b/target/linux/ar71xx/files/arch/mips/ath79/mach-rbspi.c
index cb05c91..c94eda9 100644
--- a/target/linux/ar71xx/files/arch/mips/ath79/mach-rbspi.c
+++ b/target/linux/ar71xx/files/arch/mips/ath79/mach-rbspi.c
@@ -645,6 +645,7 @@ static struct gen_74x164_chip_platform_data rbspi_ssr_data = {
 static int rbspi_spi_cs_gpios[] = {
 	-ENOENT,	/* CS0 is always -ENOENT: natively handled */
 	-ENOENT,	/* CS1 can be updated by the code as necessary */
+	-ENOENT,	/* CS2 can be updated by the code as necessary */
 };
 
 static struct ath79_spi_platform_data rbspi_ath79_spi_data = {
@@ -669,6 +670,11 @@ static struct spi_board_info rbspi_spi_info[] = {
 		.max_speed_hz	= 25000000,
 		.modalias	= "74x164",
 		.platform_data	= &rbspi_ssr_data,
+	}, {
+		.bus_num	= 0,
+		.chip_select	= 2,
+		.max_speed_hz	= 2000000,
+		.modalias	= "spidev",
 	}
 };
 
@@ -729,7 +735,7 @@ static void __init rbspi_peripherals_setup(u32 flags)
 {
 	unsigned spi_n;
 
-	if (flags & RBSPI_HAS_SSR)
+	if ((flags & RBSPI_HAS_SSR) || (flags & RBSPI_HAS_POE))
 		spi_n = ARRAY_SIZE(rbspi_spi_info);
 	else
 		spi_n = 1;     /* only one device on bus0 */
@@ -861,6 +867,9 @@ static void __init rbspi_952_750r2_setup(u32 flags)
 	if (flags & RBSPI_HAS_SSR)
 		rbspi_spi_cs_gpios[1] = RB952_GPIO_SSR_CS;
 
+	if (flags & RBSPI_HAS_POE)
+		rbspi_spi_cs_gpios[2] = RB952_GPIO_POE_STATUS;
+
 	rbspi_peripherals_setup(flags);
 
 	/*
@@ -976,6 +985,14 @@ static void __init rb962_setup(void)
 	ath79_eth0_data.mii_bus_dev = &ath79_mdio0_device.dev;
 	ath79_register_eth(0);
 
+	/* init GMAC1 */
+	ath79_init_mac(ath79_eth1_data.mac_addr, ath79_mac_base, 5);
+	ath79_eth1_pll_data.pll_1000 = 0x03000101;
+	ath79_eth1_data.phy_if_mode = PHY_INTERFACE_MODE_SGMII;
+	ath79_eth1_data.speed = SPEED_1000;
+	ath79_eth1_data.duplex = DUPLEX_FULL;
+	ath79_register_eth(1);
+
 	/* WLAN1 MAC is HW MAC + 7 */
 	rbspi_wlan_init(7);
 
@@ -1251,6 +1268,7 @@ MIPS_MACHINE_NONAME(ATH79_MACH_RB_MAPL, "map-hb", rbmapl_setup);
 MIPS_MACHINE_NONAME(ATH79_MACH_RB_941, "H951L", rbhapl_setup);
 MIPS_MACHINE_NONAME(ATH79_MACH_RB_911L, "911L", rb911l_setup);
 MIPS_MACHINE_NONAME(ATH79_MACH_RB_952, "952-hb", rb952_setup);
+MIPS_MACHINE_NONAME(ATH79_MACH_RB_960, "960", rb962_setup);
 MIPS_MACHINE_NONAME(ATH79_MACH_RB_962, "962", rb962_setup);
 MIPS_MACHINE_NONAME(ATH79_MACH_RB_750UPR2, "750-hb", rb750upr2_setup);
 MIPS_MACHINE_NONAME(ATH79_MACH_RB_LHG5, "lhg", rblhg_setup);
diff --git a/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h b/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h
index 900b4ec..b414c77 100644
--- a/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h
+++ b/target/linux/ar71xx/files/arch/mips/ath79/machtypes.h
@@ -223,6 +223,7 @@ enum ath79_mach_type {
 	ATH79_MACH_RB_951G,			/* Mikrotik RouterBOARD 951G */
 	ATH79_MACH_RB_951U,			/* Mikrotik RouterBOARD 951Ui-2HnD */
 	ATH79_MACH_RB_952,			/* MikroTik RouterBOARD 951Ui-2nD / 952Ui-5ac2nD */
+	ATH79_MACH_RB_960,			/* MikroTik RouterBOARD 960PGS */
 	ATH79_MACH_RB_962,			/* MikroTik RouterBOARD 962UiGS-5HacT2HnT */
 	ATH79_MACH_RB_CAP,			/* Mikrotik RouterBOARD cAP2nD */
 	ATH79_MACH_RB_LHG5,			/* Mikrotik RouterBOARD LHG5 */
diff --git a/target/linux/ar71xx/image/mikrotik.mk b/target/linux/ar71xx/image/mikrotik.mk
index 19086ea..6c92f90 100644
--- a/target/linux/ar71xx/image/mikrotik.mk
+++ b/target/linux/ar71xx/image/mikrotik.mk
@@ -46,7 +46,7 @@ define Device/rb-nor-flash-16M
   DEVICE_PACKAGES := rbcfg rssileds -nand-utils kmod-ledtrig-gpio
   IMAGE_SIZE := 16000k
   KERNEL_INSTALL := 1
-  SUPPORTED_DEVICES := rb-750-r2 rb-750up-r2 rb-750p-pbr2 rb-911-2hn rb-911-5hn rb-931-2nd rb-941-2nd rb-951ui-2nd rb-952ui-5ac2nd rb-962uigs-5hact2hnt rb-lhg-5nd rb-map-2nd rb-mapl-2nd rb-wap-2nd rb-wapr-2nd rb-sxt-2nd-r3
+  SUPPORTED_DEVICES := rb-750-r2 rb-750up-r2 rb-750p-pbr2 rb-911-2hn rb-911-5hn rb-931-2nd rb-941-2nd rb-951ui-2nd rb-952ui-5ac2nd rb-960pgs rb-962uigs-5hact2hnt rb-lhg-5nd rb-map-2nd rb-mapl-2nd rb-wap-2nd rb-wapr-2nd rb-sxt-2nd-r3
   IMAGE/sysupgrade.bin := append-kernel | kernel2minor -s 1024 -e | pad-to $$$$(BLOCKSIZE) | \
 	append-rootfs | pad-rootfs | append-metadata | check-size $$$$(IMAGE_SIZE)
 endef
diff --git a/target/linux/ar71xx/patches-4.14/701-MIPS-ath79-add-routerboard-detection.patch b/target/linux/ar71xx/patches-4.14/701-MIPS-ath79-add-routerboard-detection.patch
index ae9e777..84ae238 100644
--- a/target/linux/ar71xx/patches-4.14/701-MIPS-ath79-add-routerboard-detection.patch
+++ b/target/linux/ar71xx/patches-4.14/701-MIPS-ath79-add-routerboard-detection.patch
@@ -1,6 +1,6 @@
 --- a/arch/mips/ath79/prom.c
 +++ b/arch/mips/ath79/prom.c
-@@ -136,6 +136,32 @@ void __init prom_init(void)
+@@ -136,6 +136,33 @@ void __init prom_init(void)
  		initrd_end = initrd_start + fw_getenvl("initrd_size");
  	}
  #endif
@@ -17,6 +17,7 @@
 +	    strstr(arcs_cmdline, "board=H951L") ||
 +	    strstr(arcs_cmdline, "board=952-hb") ||
 +	    strstr(arcs_cmdline, "board=953gs") ||
++	    strstr(arcs_cmdline, "board=960") ||
 +	    strstr(arcs_cmdline, "board=962") ||
 +	    strstr(arcs_cmdline, "board=lhg") ||
 +	    strstr(arcs_cmdline, "board=map-hb") ||
-- 
2.27.0

